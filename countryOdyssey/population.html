<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Population Guesser Game</title>
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <style>
    :root{
      --bg:#0f172a;--fg:#e2e8f0;--muted:#94a3b8;--accent:#22c55e;--danger:#ef4444;--panel:#111827;
      --map-bg:#0b1020;--card-bg:rgba(17,24,39,.84);--border-color:#0b1225;
    }
    
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
    }
    
    body {
      background: var(--map-bg);
      color: var(--fg);
      font: 14px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }
    
    #app {
      height: 100%;
      position: relative;
    }
    
    #map {
      height: 100%;
      width: 100%;
      background: var(--map-bg);
    }
    
    .hud {
      position: absolute;
      z-index: 1000;
      left: 50%;
      bottom: 80px;
      transform: translateX(-50%);
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    
    .card {
      background: var(--card-bg);
      backdrop-filter: blur(1px);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      padding: 15px 20px;
      min-width: 200px;
      text-align: center;
    }
    
    .game-controls {
      display: flex;
      gap: 12px;
      justify-content: center;
      margin-bottom: 15px;
    }
    
    .control-btn {
      display: flex;
      align-items: center;
      gap: 8px;
      background: #1f2937;
      color: #e5e7eb;
      border: 1px solid #374151;
      border-radius: 8px;
      padding: 10px 16px;
      cursor: pointer;
      transition: all 0.2s ease;
      font-size: 14px;
      font-weight: 500;
    }
    
    .control-btn:hover {
      background: #374151;
      border-color: #4b5563;
      transform: translateY(-1px);
    }
    
    .start-btn {
      background: #059669;
      border-color: #10b981;
      color: #d1fae5;
    }
    
    .start-btn:hover {
      background: #047857;
      border-color: #059669;
    }
    
    .icon-btn {
      background: #1f2937;
      border-color: #374151;
      color: #9ca3af;
      min-width: 44px;
      justify-content: center;
    }
    
    .game-info {
      display: none;
    }
    
    .row {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
      justify-content: center;
    }
    
    .k {
      color: #94a3b8;
    }
    
    .v {
      font-weight: 700;
    }
    
    .population-display {
      font-size: 24px;
      font-weight: 700;
      color: var(--accent);
      margin: 10px 0;
      transition: color 0.3s ease;
    }
    
    .population-display.higher {
      color: #22c55e;
    }
    
    .population-display.lower {
      color: #ef4444;
    }
    

    
    .toast {
      position: absolute;
      right: 12px;
      top: 64px;
      z-index: 700;
      background: #111827;
      border: 1px solid #1e293b;
      border-radius: 10px;
      padding: 10px 12px;
      display: none;
    }
    
    .toast.ok {
      border-color: #14532d;
    }
    
    .toast.err {
      border-color: #4c0519;
    }
    
    /* Statistics Modal */
    .stats-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      z-index: 2000;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .stats-content {
      background: #ffffff;
      border: none;
      border-radius: 16px;
      max-width: 480px;
      width: 90%;
      max-height: 85vh;
      overflow-y: auto;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
    }
    
    .stats-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 24px 24px 20px 24px;
      border-bottom: 1px solid #e5e7eb;
    }
    
    .stats-header h3 {
      margin: 0;
      color: #333333;
      font-size: 20px;
      font-weight: 600;
    }
    
    .close-btn {
      background: #f3f4f6;
      border: none;
      color: #6b7280;
      font-size: 20px;
      cursor: pointer;
      padding: 0;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      transition: all 0.2s ease;
    }
    
    .close-btn:hover {
      background: #e5e7eb;
      color: #374151;
    }
    
    .stats-body {
      padding: 24px;
    }
    
    .stats-summary {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
      margin-bottom: 28px;
    }
    
    .stat-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 20px;
      background: #f9fafb;
      border-radius: 12px;
      border: 1px solid #e5e7eb;
    }
    
    .stat-label {
      color: #6b7280;
      font-size: 14px;
      font-weight: 500;
    }
    
    .stat-value {
      color: #333333;
      font-weight: 700;
      font-size: 18px;
    }
    
    .countries-list h4 {
      margin: 0 0 16px 0;
      color: #333333;
      font-size: 16px;
      font-weight: 600;
    }
    
    .countries-container {
      max-height: 240px;
      overflow-y: auto;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      padding: 16px;
      background: #f9fafb;
    }
    
    .country-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 16px;
      margin-bottom: 8px;
      background: #ffffff;
      border-radius: 8px;
      border-left: 4px solid transparent;
      transition: all 0.2s ease;
    }
    
    .country-item:hover {
      transform: translateY(-1px);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    
    .country-item.correct {
      border-left-color: #10b981;
    }
    
    .country-item.wrong {
      border-left-color: #ef4444;
    }
    
    .country-item.skipped {
      border-left-color: #f59e0b;
    }
    
    .country-name {
      color: #333333;
      font-weight: 500;
      font-size: 14px;
    }
    
    .country-result {
      font-size: 11px;
      padding: 4px 10px;
      border-radius: 20px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .country-result.correct {
      background: #10b981;
      color: white;
    }
    
    .country-result.wrong {
      background: #ef4444;
      color: white;
    }
    
    .country-result.skipped {
      background: #f59e0b;
      color: white;
    }
    
    .no-countries {
      text-align: center;
      color: #9ca3af;
      font-style: italic;
      margin: 24px 0;
      font-size: 14px;
    }
    
    @media (max-width: 600px) {
      .card {
        max-width: 90svw;
      }
      
      .stats-content {
        width: 95%;
        margin: 20px;
        max-height: 90vh;
      }
      
      .stats-summary {
        grid-template-columns: 1fr;
        gap: 12px;
      }
      
      .stats-header {
        padding: 20px 20px 16px 20px;
      }
      
      .stats-body {
        padding: 20px;
      }
      
      .stat-item {
        padding: 14px 16px;
      }
      
      .countries-container {
        max-height: 200px;
      }
    }
  </style>
</head>
<body>
  <div id="app">
    <div id="map"></div>
    
    <div class="hud">
      <div class="card">
        <div class="game-controls">
          <button id="startBtn" class="control-btn start-btn">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
              <path d="M8 5v14l11-7z"/>
            </svg>
            Start
          </button>
          <button id="pauseBtn" class="control-btn icon-btn" style="display: none;">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
              <path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/>
            </svg>
          </button>
          <button id="skipBtn" class="control-btn icon-btn" style="display: none;">
            <svg width="20" height="20" viewBox="0 0 32 32" fill="currentColor">
              <path d="M28.448,17.261L15.552,27.739C14.698,28.432,14,28.1,14,27v-6.938l-9.448,7.676
	C3.698,28.432,3,28.1,3,27V5c0-1.1,0.698-1.432,1.552-0.739L14,11.937V5c0-1.1,0.698-1.432,1.552-0.739l12.896,10.478
	C29.302,15.432,29.302,16.568,28.448,17.261z"/>
            </svg>
          </button>
          <button id="resetBtn" class="control-btn icon-btn" style="display: none;">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
              <path d="M12 5V1L7 6l5 5V7c3.31 0 6 2.69 6 6s-2.69 6-6 6-6-2.69-6-6H4c0 4.42 3.58 8 8 8s8-3.58 8-8-3.58-8-8-8z"/>
            </svg>
          </button>
          <button id="settingsBtn" class="control-btn icon-btn" style="display: none;">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
              <path d="M19.14,12.94c0.04-0.3,0.06-0.61,0.06-0.94c0-0.32-0.02-0.64-0.07-0.94l2.03-1.58c0.18-0.14,0.23-0.41,0.12-0.61 l-1.92-3.32c-0.12-0.22-0.37-0.29-0.59-0.22l-2.39,0.96c-0.5-0.38-1.03-0.7-1.62-0.94L14.4,2.81c-0.04-0.24-0.24-0.41-0.48-0.41 h-3.84c-0.24,0-0.43,0.17-0.47,0.41L9.25,5.35C8.66,5.59,8.12,5.92,7.63,6.29L5.24,5.33c-0.22-0.08-0.47,0-0.59,0.22L2.74,8.87 C2.62,9.08,2.66,9.34,2.86,9.48l2.03,1.58C4.84,11.36,4.8,11.69,4.8,12s0.02,0.64,0.07,0.94l-2.03,1.58 c-0.18,0.14-0.23,0.41,0.12,0.61l1.92,3.32c0.12,0.22,0.37,0.29,0.59,0.22l2.39-0.96c0.5,0.38,1.03,0.7,1.62,0.94l0.36,2.54 c0.05,0.24,0.24,0.41,0.48,0.41h3.84c0.24,0,0.43-0.17,0.47-0.41l0.36-2.54c0.59-0.24,1.13-0.56,1.62-0.94l2.39,0.96 c0.22,0.08,0.47,0,0.59-0.22l1.92-3.32c0.12-0.22,0.07-0.47-0.12-0.61L19.14,12.94z M12,15.6c-1.98,0-3.6-1.62-3.6-3.6 s1.62-3.6,3.6-3.6s3.6,1.62,3.6,3.6S13.98,15.6,12,15.6z"/>
            </svg>
          </button>
          <button id="statsBtn" class="control-btn icon-btn" style="display: none;">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
              <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"/>
            </svg>
          </button>
        </div>
        <div id="gameInfo" class="game-info">
          <div class="population-display" id="targetPopulation">‚Ä¶</div>
          <div class="row"><span class="k">Streak:</span> <span id="streak" class="v">0</span></div>
          <div class="row"><span class="k">Time:</span> <span id="timer" class="v">00:00</span></div>
        </div>
      </div>
    </div>
    
    <div id="toast" class="toast">‚Ä¶</div>
    
    <!-- Statistics Modal -->
    <div id="statsModal" class="stats-modal" style="display: none;">
      <div class="stats-content">
        <div class="stats-header">
          <h3>Game Statistics</h3>
          <button id="closeStats" class="close-btn">√ó</button>
        </div>
        <div class="stats-body">
          <div class="stats-summary">
            <div class="stat-item">
              <span class="stat-label">Correct:</span>
              <span id="statsCorrect" class="stat-value">0</span>
            </div>
            <div class="stat-item">
              <span class="stat-label">Wrong:</span>
              <span id="statsWrong" class="stat-value">0</span>
            </div>
            <div class="stat-item">
              <span class="stat-label">Skipped:</span>
              <span id="statsSkipped" class="stat-value">0</span>
            </div>
            <div class="stat-item">
              <span class="stat-label">Accuracy:</span>
              <span id="statsAccuracy" class="stat-value">0%</span>
            </div>
          </div>
          <div class="countries-list">
            <h4>Countries Clicked</h4>
            <div id="countriesList" class="countries-container">
              <p class="no-countries">No countries clicked yet</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
  <script>
    // --- Map setup ---
    console.log('Initializing map...');
    const map = L.map('map', {
      worldCopyJump: true,
      preferCanvas: false,
      zoomSnap: 0.5,
      zoomDelta: 0.5,
    }).setView([20, 0], 2);
    console.log('Map initialized:', map);

    console.log('Adding tile layer...');
    const tileLayer = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_nolabels/{z}/{x}/{y}{r}.png', {
      maxZoom: 6,
      minZoom: 2,
      attribution: '&copy; OpenStreetMap & Carto',
      subdomains: 'abcd'
    }).addTo(map);
    console.log('Tile layer added:', tileLayer);

    // --- Game state ---
    const state = {
      features: [],
      target: null,
      streak: 0,
      layer: null,
      gameStartTime: null,
      timerInterval: null,
      isPaused: false,
      pauseStartTime: null,
      allFeatures: [],
      completedCountries: new Set(),
      populationData: {},
      currentFactor: 'HIGHER',
      stats: {
        correct: 0,
        wrong: 0,
        skipped: 0,
        countriesClicked: []
      }
    };

    const $ = (id) => document.getElementById(id);
    const toast = (msg, kind = 'ok') => {
      const el = $('toast');
      el.className = 'toast ' + (kind === 'ok' ? 'ok' : 'err');
      el.textContent = msg;
      el.style.display = 'block';
      clearTimeout(el._t);
      el._t = setTimeout(() => { el.style.display = 'none'; }, 1200);
    };

    // Normalize country names for comparison
    const norm = (s) => (s || '')
      .toLowerCase()
      .normalize('NFD').replace(/[\u0300-\u036f]/g, '')
      .replace(/[^a-z0-9]+/g, ' ').trim();

    // Choose display name from NE props
    const pickName = (p) => p.name || p.ADMIN || p.NAME_LONG || p.NAME || p.SOVEREIGNT || p.BRK_NAME;

    // Avoid Antarctica and disputed water polygons
    const keep = (f) => {
      if (!f || !f.properties) {
        console.warn('Feature missing properties:', f);
        return false;
      }
      const n = pickName(f.properties);
      if (!n) {
        console.warn('Feature has no valid name:', f.properties);
        return false;
      }
      const bad = ['Antarctica'];
      return !bad.includes(n);
    };

    // Styling
    const baseStyle = { color: '#2c3e50', weight: 1, fillColor: '#60a5fa', fillOpacity: 0.08 };
    const hoverStyle = { weight: 2, fillOpacity: 0.25 };
    const okStyle = { fillColor: '#16a34a', fillOpacity: 0.35 };
    const badStyle = { fillColor: '#ef4444', fillOpacity: 0.35 };

    // Load population data from population.txt
    async function loadPopulationData() {
      try {
        const response = await fetch('population.txt');
        const text = await response.text();
        const lines = text.split('\n').filter(line => line.trim());
        
        lines.forEach(line => {
          const parts = line.split(' ‚Äì ');
          if (parts.length === 2) {
            const countryName = parts[0].trim();
            const populationStr = parts[1].trim().replace(/,/g, '');
            const population = parseInt(populationStr);
            if (!isNaN(population)) {
              state.populationData[countryName] = population;
            }
          }
        });
        
        console.log(`Loaded population data for ${Object.keys(state.populationData).length} countries`);
      } catch (error) {
        console.error('Failed to load population data:', error);
        toast('Failed to load population data', 'err');
      }
    }

    function startGame() {
      // Show game info and hide start button
      document.getElementById('gameInfo').style.display = 'block';
      document.getElementById('startBtn').style.display = 'none';
      
      // Show game buttons
      document.getElementById('pauseBtn').style.display = 'flex';
      document.getElementById('skipBtn').style.display = 'flex';
      document.getElementById('settingsBtn').style.display = 'flex';
      document.getElementById('statsBtn').style.display = 'flex';
      document.getElementById('resetBtn').style.display = 'flex';
      
      // Reset pause state
      state.isPaused = false;
      state.pauseStartTime = null;
      
      // Start the timer
      startTimer();
      
      // Set initial target
      setTargetRandom();
    }

    function startTimer() {
      if (state.timerInterval) clearInterval(state.timerInterval);
      state.gameStartTime = Date.now();
      state.timerInterval = setInterval(updateTimer, 1000);
    }

    function updateTimer() {
      if (!state.gameStartTime) return;
      const elapsed = Math.floor((Date.now() - state.gameStartTime) / 1000);
      const minutes = Math.floor(elapsed / 60);
      const seconds = elapsed % 60;
      $('timer').textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    }

    function stopTimer() {
      if (state.timerInterval) {
        clearInterval(state.timerInterval);
        state.timerInterval = null;
      }
    }

    function pauseGame() {
      state.isPaused = true;
      state.pauseStartTime = Date.now();
      
      if (state.timerInterval) {
        clearInterval(state.timerInterval);
        state.timerInterval = null;
      }
      
      if (state.layer) {
        state.layer.remove();
      }
      
      const pauseBtn = document.getElementById('pauseBtn');
      pauseBtn.innerHTML = `
        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
          <path d="M8 5v14l11-7z"/>
        </svg>
      `;
      
      toast('‚è∏Ô∏è Game Paused');
    }

    function resumeGame() {
      state.isPaused = false;
      
      if (state.pauseStartTime) {
        const pauseDuration = Date.now() - state.pauseStartTime;
        state.gameStartTime += pauseDuration;
        state.pauseStartTime = null;
      }
      
      startTimer();
      
      if (state.layer) {
        state.layer.addTo(map);
      }
      
      const pauseBtn = document.getElementById('pauseBtn');
      pauseBtn.innerHTML = `
        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
          <path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/>
        </svg>
      `;
      
      toast('‚ñ∂Ô∏è Game Resumed');
    }

    function setTargetRandom() {
      if (!state.features || state.features.length === 0) {
        console.warn('No features available for target selection');
        return;
      }
      
      // Filter out completed countries
      const availableCountries = state.features.filter(feature => {
        const countryName = pickName(feature.properties);
        return !state.completedCountries.has(countryName);
      });
      
      if (availableCountries.length === 0) {
        $('targetPopulation').textContent = 'üéâ ALL COUNTRIES COMPLETED!';
        toast('üéâ Congratulations! You\'ve completed all countries!', 'ok');
        stopTimer();
        return;
      }
      
      // Select random target from available countries
      state.target = availableCountries[Math.floor(Math.random() * availableCountries.length)];
      if (state.target && state.target.properties) {
        const countryName = pickName(state.target.properties);
        const population = state.populationData[countryName];
        
        if (population !== undefined) {
          // Randomly choose higher or lower
          const factor = Math.random() < 0.5 ? 'HIGHER' : 'LOWER';
          state.currentFactor = factor;
          
          // Update population display with color based on factor
          const populationElement = $('targetPopulation');
          populationElement.textContent = population.toLocaleString();
          populationElement.className = 'population-display ' + (factor === 'HIGHER' ? 'higher' : 'lower');
        } else {
          console.warn('Population data not found for:', countryName);
          setTargetRandom(); // Try another country
        }
      }
    }

    function updateStreak(delta) {
      state.streak = Math.max(0, state.streak + delta);
      $('streak').textContent = state.streak;
    }

    function buildLayer(geojson) {
      if (state.layer) state.layer.remove();

      state.layer = L.geoJSON(geojson, {
        filter: keep,
        style: baseStyle,
        onEachFeature: (feature, layer) => {
          layer.on({
            mouseover: (e) => e.target.setStyle(hoverStyle),
            mouseout: (e) => state.layer.resetStyle(e.target),
            click: (e) => onCountryClick(feature, e.target)
          });
        }
      }).addTo(map);

      state.allFeatures = state.layer.toGeoJSON().features;
      state.features = [...state.allFeatures];
      
      if (state.features && state.features.length > 0) {
        console.log(`Loaded ${state.features.length} features`);
      } else {
        console.error('No features loaded from GeoJSON');
        throw new Error('No features loaded from GeoJSON');
      }
    }

    function onCountryClick(feature, layer) {
      const clickedCountryName = pickName(feature.properties);
      const targetCountryName = pickName(state.target.properties);
      
      if (clickedCountryName === targetCountryName) {
        // Make country permanently green and unclickable
        layer.setStyle(okStyle);
        layer.off('click');
        layer.off('mouseover');
        layer.off('mouseout');
        
        state.completedCountries.add(clickedCountryName);
        
        toast('‚úÖ Correct: ' + clickedCountryName, 'ok');
        updateStreak(+1);
        
        state.stats.correct++;
        state.stats.countriesClicked.push({
          name: clickedCountryName,
          result: 'correct',
          timestamp: new Date().toLocaleTimeString()
        });
        
        try { map.fitBounds(layer.getBounds(), { maxZoom: 4, animate: true }); } catch {}
        setTimeout(() => setTargetRandom(), 650);
      } else {
        // Check if the clicked country meets the population criteria
        const clickedPopulation = state.populationData[clickedCountryName];
        const targetPopulation = state.populationData[targetCountryName];
        
        if (clickedPopulation !== undefined && targetPopulation !== undefined) {
          let isCorrect = false;
          
          if (state.currentFactor === 'HIGHER') {
            isCorrect = clickedPopulation > targetPopulation;
          } else {
            isCorrect = clickedPopulation < targetPopulation;
          }
          
          if (isCorrect) {
            // Make country permanently green and unclickable
            layer.setStyle(okStyle);
            layer.off('click');
            layer.off('mouseover');
            layer.off('mouseout');
            
            state.completedCountries.add(clickedCountryName);
            
            toast(`‚úÖ Correct! ${clickedCountryName} has ${state.currentFactor.toLowerCase()} population`, 'ok');
            updateStreak(+1);
            
            state.stats.correct++;
            state.stats.countriesClicked.push({
              name: clickedCountryName,
              result: 'correct',
              timestamp: new Date().toLocaleTimeString()
            });
            
            try { map.fitBounds(layer.getBounds(), { maxZoom: 4, animate: true }); } catch {}
            setTimeout(() => setTargetRandom(), 650);
          } else {
            layer.setStyle(badStyle);
            toast(`‚ùå Wrong. ${clickedCountryName} doesn't have ${state.currentFactor.toLowerCase()} population`, 'err');
            updateStreak(-1);
            
            state.stats.wrong++;
            state.stats.countriesClicked.push({
              name: clickedCountryName,
              result: 'wrong',
              timestamp: new Date().toLocaleTimeString()
            });
          }
        } else {
          layer.setStyle(badStyle);
          toast('‚ùå Population data not available for this country', 'err');
          updateStreak(-1);
          
          state.stats.wrong++;
          state.stats.countriesClicked.push({
            name: clickedCountryName,
            result: 'wrong',
            timestamp: new Date().toLocaleTimeString()
          });
        }
      }
    }

    // Event listeners
    $('startBtn').addEventListener('click', startGame);
    
    $('pauseBtn').addEventListener('click', () => {
      if (!state.isPaused) {
        pauseGame();
      } else {
        resumeGame();
      }
    });
    
    $('settingsBtn').addEventListener('click', () => {
      toggleTheme();
    });
    
    $('skipBtn').addEventListener('click', () => {
      const skippedCountryName = pickName(state.target.properties);
      toast('‚è≠Ô∏è Skipped: ' + skippedCountryName);
      state.stats.skipped++;
      
      state.stats.countriesClicked.push({
        name: skippedCountryName,
        result: 'skipped',
        timestamp: new Date().toLocaleTimeString()
      });
      
      setTargetRandom();
    });
    
    $('statsBtn').addEventListener('click', showStats);
    
    $('resetBtn').addEventListener('click', () => {
      state.streak = 0; $('streak').textContent = '0';
      if (state.layer) state.layer.setStyle(baseStyle);
      
      document.getElementById('gameInfo').style.display = 'none';
      document.getElementById('startBtn').style.display = 'flex';
      
      document.getElementById('pauseBtn').style.display = 'none';
      document.getElementById('skipBtn').style.display = 'none';
      document.getElementById('settingsBtn').style.display = 'none';
      document.getElementById('statsBtn').style.display = 'none';
      document.getElementById('resetBtn').style.display = 'none';
      
      stopTimer();
      $('timer').textContent = '00:00';
      $('targetPopulation').textContent = '‚Ä¶';
      $('targetPopulation').className = 'population-display';
      
      state.stats.correct = 0;
      state.stats.wrong = 0;
      state.stats.skipped = 0;
      state.stats.countriesClicked = [];
      
      state.isPaused = false;
      state.pauseStartTime = null;
      state.completedCountries.clear();
      
      if (state.layer) {
        state.layer.eachLayer(layer => {
          layer.setStyle(baseStyle);
          layer.on({
            mouseover: (e) => e.target.setStyle(hoverStyle),
            mouseout: (e) => state.layer.resetStyle(e.target),
            click: (e) => onCountryClick(layer.feature, e.target)
          });
        });
      }
      
      const pauseBtn = document.getElementById('pauseBtn');
      pauseBtn.innerHTML = `
        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
          <path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/>
        </svg>
      `;
    });

    // Statistics functions
    function showStats() {
      // Update statistics display
      $('statsCorrect').textContent = state.stats.correct;
      $('statsWrong').textContent = state.stats.wrong;
      $('statsSkipped').textContent = state.stats.skipped;
      
      const total = state.stats.correct + state.stats.wrong;
      const accuracy = total > 0 ? Math.round((state.stats.correct / total) * 100) : 0;
      $('statsAccuracy').textContent = accuracy + '%';
      
      // Update countries list
      const countriesList = $('countriesList');
      if (state.stats.countriesClicked.length === 0) {
        countriesList.innerHTML = '<p class="no-countries">No countries clicked yet</p>';
      } else {
        countriesList.innerHTML = state.stats.countriesClicked.map(country => {
          let resultClass = country.result;
          let resultText = country.result;
          
          if (country.result === 'correct') {
            resultText = '‚úÖ Correct';
          } else if (country.result === 'wrong') {
            resultText = '‚ùå Wrong';
          } else if (country.result === 'skipped') {
            resultText = '‚è≠Ô∏è Skipped';
          }
          
          return `
            <div class="country-item ${resultClass}">
              <span class="country-name">${country.name}</span>
              <span class="country-result ${resultClass}">${resultText}</span>
            </div>
          `;
        }).join('');
      }
      
      // Show modal
      $('statsModal').style.display = 'flex';
    }

    function hideStats() {
      $('statsModal').style.display = 'none';
    }

    function toggleTheme() {
      const root = document.documentElement;
      const currentTheme = root.getAttribute('data-theme');
      const newTheme = currentTheme === 'light' ? 'dark' : 'light';
      
      root.setAttribute('data-theme', newTheme);
      localStorage.setItem('theme', newTheme);
      
      if (newTheme === 'light') {
        map.removeLayer(tileLayer);
        const newTileLayer = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_nolabels/{z}/{x}/{y}{r}.png', {
          maxZoom: 6,
          minZoom: 2,
          attribution: '&copy; OpenStreetMap & Carto',
          subdomains: 'abcd'
        }).addTo(map);
        toast('‚òÄÔ∏è Light mode enabled');
      } else {
        map.removeLayer(tileLayer);
        const newTileLayer = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_nolabels/{z}/{x}/{y}{r}.png', {
          maxZoom: 6,
          minZoom: 2,
          attribution: '&copy; OpenStreetMap & Carto',
          subdomains: 'abcd'
        }).addTo(map);
        toast('üåô Dark mode enabled');
      }
    }

    // Load lightweight world countries (Natural Earth 110m)
    const SOURCES = [
      './countries.geojson',
      'countries.geojson',
      '/countries.geojson',
      'countries.geojson',
      'https://datahub.io/core/geo-countries/r/0.geojson',
      'https://raw.githubusercontent.com/johan/world.geo.json/master/countries.geo.json'
    ];
    
    async function fetchJSONFlexible(url) {
      const res = await fetch(url, { cache: 'no-store' });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const text = await res.text();
      console.log(`[${url}] Raw response length:`, text.length);
      console.log(`[${url}] First 200 chars:`, text.substring(0, 200));
      const data = JSON.parse(text.replace(/^\uFEFF/, ''));
      console.log(`[${url}] Parsed data:`, data);
      if (data && data.features) {
        console.log(`[${url}] Features count:`, data.features.length);
        if (data.features.length > 0) {
          console.log(`[${url}] First feature:`, data.features[0]);
        }
      }
      return data;
    }

    (async function loadBoundaries() {
      // Initialize theme first
      initTheme();
      
      // Load population data first
      await loadPopulationData();
      
      for (const url of SOURCES) {
        try {
          console.log('[countries] trying', url);
          const data = await fetchJSONFlexible(url);
          if (!data || !Array.isArray(data.features)) throw new Error('Not a GeoJSON FeatureCollection');
          buildLayer(data); 
          toast('Loaded country boundaries'); 
          return;
        } catch (err) { 
          console.warn('Boundary source failed:', url, err); 
        }
      }
      alert('Failed to load country boundaries from all sources. Make sure "countries.geojson" is in the SAME folder as index.html, and that your server root is that folder. Try visiting your /countries.geojson directly to confirm it serves raw JSON.');
    })();

    // Statistics button event listener
    $('statsBtn').addEventListener('click', showStats);
    
    // Close statistics modal
    $('closeStats').addEventListener('click', hideStats);
    
    // Close modal when clicking outside
    $('statsModal').addEventListener('click', (e) => {
      if (e.target === $('statsModal')) {
        hideStats();
      }
    });

    // Initialize theme
    function initTheme() {
      const savedTheme = localStorage.getItem('theme') || 'dark';
      document.documentElement.setAttribute('data-theme', savedTheme);
      
      // Set initial map tiles based on theme
      if (savedTheme === 'light') {
        map.removeLayer(tileLayer);
        const newTileLayer = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_nolabels/{z}/{x}/{y}{r}.png', {
          maxZoom: 6,
          minZoom: 2,
          attribution: '&copy; OpenStreetMap & Carto',
          subdomains: 'abcd'
        }).addTo(map);
      } else {
        // Already using dark theme tiles
      }
    }

    // Improve mobile playability: two-finger pan
    map.touchZoom.enable();
    map.dragging.enable();
    map.on('touchstart', (e) => { if (e.touches && e.touches.length === 1) { map.dragging.disable(); } });
    map.on('touchend', () => map.dragging.enable());
  </script>
</body>
</html>
